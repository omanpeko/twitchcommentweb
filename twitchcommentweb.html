<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>真ナダルーレット改ver.2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .top-bar {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        #channelUrl {
            width: 500px;
            padding: 5px;
            font-size: 14px;
            height: 32px;
            box-sizing: border-box;
        }
        #connectButton {
            margin-left: 10px;
            height: 32px;
        }
        .content {
            display: none; /* 初期状態で非表示 */
        }
        #chat {
            width: 500px;
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            background-color: #f9f9f9;
            margin-right: 20px;
        }
        .message {
            margin: 5px 0;
        }
        .username {
            font-weight: bold;
        }
        #ranking, #participantList {
            width: 300px;
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f1f1f1;
            overflow-y: auto;
            margin-right: 20px;
        }
        .ranking-item, .participant-item {
            display: flex;
            align-items: center;
            padding: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 14px;
            height: 28px;
        }
        .ranking-item:first-child, .participant-item:first-child {
            background-color: #fff9cc; /* 薄い黄色 */
        }
        .ranking-item:nth-child(-n+3), .participant-item:nth-child(-n+3) {
            font-size: 16px; /* 1位～3位は少し大きく */
            height: 28px; /* 高さはそのまま */
        }
        .ranking-item:nth-child(n+4), .participant-item:nth-child(n+4) {
            height: 24px; /* それ以下の順位は4px小さく */
        }
        .ranking-item span.name, .participant-item span.name {
            flex-grow: 1;
            text-align: left;
            margin-left: 10px;
        }
        .ranking-item span.points, .participant-item span.points {
            width: 60px;
            text-align: right;
        }
        .participant-item button {
            margin-left: 5px;
            font-size: 12px;
            padding: 2px 5px;
            cursor: pointer;
        }
        .image-display {
            display: none; /* 初期状態で非表示 */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: auto;
            height: auto;
            max-width: 80%;
            max-height: 80%;
            z-index: 1000;
            border: 5px solid #fff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        #yuriyanImage {
            height: 420px; /* 高さを420pxに設定 */
            width: auto; /* 縦横比を維持 */
        }
        #targetName {
            display: none;
            position: fixed;
            top: calc(50% - 270px); /* 中央から270px上 */
            left: 50%;
            transform: translate(-50%, 0);
            padding: 10px;
            background-color: #fff;
            border: 2px solid #ccc;
            font-size: 24px;
            font-weight: bold;
            z-index: 1001;
        }
        #resultText {
            display: none;
            position: fixed;
            top: calc(50% + 230px); /* 中央から230px下 */
            left: 50%;
            transform: translate(-50%, 0);
            padding: 10px;
            background-color: #fff;
            border: 2px solid #ccc;
            font-size: 24px;
            font-weight: bold;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <h1>真ナダルーレット改ver.2</h1>
    <div class="top-bar">
        <input type="text" id="channelUrl" placeholder="Twitch配信URLを入力">
        <button id="connectButton" onclick="connectChat()">接続</button>
    </div>
    <div class="content" id="content">
        <div>
            <h2>チャットログ</h2>
            <div id="chat"></div>
        </div>
        <div>
            <h2>ランキング</h2>
            <div id="ranking"></div>
        </div>
        <div>
            <h2>参加者リスト</h2>
            <div id="participantList"></div>
        </div>
    </div>
    <img id="nadalImage" src="nadal.jpg" alt="ナダル" class="image-display">
    <img id="yuriyanImage" src="yuriyan.png" alt="ゆりやん" class="image-display">
    <div id="targetName"></div>
    <div id="resultText"></div>

    <script>
        let ws;
        const ranking = {};
        let isRouletteRunning = false;

        function connectChat() {
            const channelUrl = document.getElementById('channelUrl').value;
            const channelName = extractChannelName(channelUrl);

            if (!channelName) {
                alert("有効なTwitch配信URLを入力してください。");
                return;
            }

            if (ws) {
                ws.close();
            }

            ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

            ws.onopen = () => {
                ws.send('CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership');
                ws.send('PASS SCHMOOPIIE'); // Anonymous connection
                ws.send('NICK justinfan' + Math.floor(Math.random() * 100000));
                ws.send('JOIN #' + channelName);
                console.log('Connected to channel:', channelName);
                
                // Show content after successful connection
                document.getElementById('content').style.display = 'flex';
            };

            ws.onmessage = (event) => {
                const messages = event.data.trim().split('\n');
                messages.forEach(message => {
                    console.log('Raw message:', message); // 受信した生データを出力
                    handleMessage(message);
                });
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('Disconnected');
            };
        }

        function extractChannelName(url) {
            const match = url.match(/twitch\.tv\/([^\/?]+)/);
            return match ? match[1] : null;
        }

        function handleMessage(data) {
            if (data.includes('PRIVMSG')) {
                const tags = parseTags(data);
                const displayName = tags['display-name'] || 'Unknown';
                const message = data.split('PRIVMSG')[1].split(':')[1];
                const color = tags['color'] || '#000000'; // デフォルトは黒色

                displayMessage(displayName, message, color);

                if ((message.includes('ナダル') || message.includes('なだる')) && !isRouletteRunning) {
                    addToRanking(displayName);
                    startImageSequence(displayName);
                }

                checkForSpecialCase(displayName, message);
            }
        }

        function parseTags(data) {
            const tagsPart = data.split(' ')[0];
            const tagPairs = tagsPart.split(';');
            const tags = {};
            tagPairs.forEach(tagPair => {
                const [key, value] = tagPair.split('=');
                tags[key] = value || '';
            });
            return tags;
        }

        function displayMessage(username, message, color) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.classList.add('message');
            div.innerHTML = `<span class="username" style="color: ${color};">${username}:</span> ${message}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function startImageSequence(targetName) {
            isRouletteRunning = true;
            const nadalImage = document.getElementById('nadalImage');
            const yuriyanImage = document.getElementById('yuriyanImage');
            const targetNameDiv = document.getElementById('targetName');
            const resultTextDiv = document.getElementById('resultText');

            let images = [nadalImage, yuriyanImage];
            let index = 0;

            // Display target name
            targetNameDiv.textContent = targetName;
            targetNameDiv.style.display = 'block';

            const intervals = [
                { duration: 2000, interval: 100 },
                { duration: 1500, interval: 300 },
                { duration: 2400, interval: 600 }
            ];

            let totalDuration = 0;
            intervals.forEach((stage) => {
                setTimeout(() => {
                    let intervalId = setInterval(() => {
                        images[index].style.display = 'none';
                        index = 1 - index;
                        images[index].style.display = 'block';
                    }, stage.interval);

                    setTimeout(() => {
                        clearInterval(intervalId);
                        images[index].style.display = 'none';
                    }, stage.duration);
                }, totalDuration);

                totalDuration += stage.duration;
            });

            // Add 1000ms delay after the sequence
            totalDuration += 1000;

            setTimeout(() => {
                const finalImage = Math.random() < 0.2 ? yuriyanImage : nadalImage;
                finalImage.style.display = 'block';

                // Display result text
                resultTextDiv.textContent = finalImage === yuriyanImage ? "ゆりやん" : "ナダル";
                resultTextDiv.style.display = 'block';

                if (finalImage === yuriyanImage) {
                    adjustPoints(targetName, 5);
                } else {
                    adjustPoints(targetName, 1);
                }

                setTimeout(() => {
                    finalImage.style.display = 'none';
                    targetNameDiv.style.display = 'none';
                    resultTextDiv.style.display = 'none';
                    isRouletteRunning = false;
                }, 5000);
            }, totalDuration);
        }

        function checkForSpecialCase(displayName, message) {
            if (displayName === "お満月ぺこり" && message.startsWith('@')) {
                const targetName = message.split(' ')[0].slice(1); // @から後の名前を取得
                if (message.includes('スーパーゆりやん')) {
                    startImageSequence(targetName);
                }
            }
        }

        function addToRanking(username) {
            if (!ranking[username]) {
                ranking[username] = 0; // 初期ポイントを設定
                updateRankingDisplay();
                updateParticipantListDisplay();
            }
        }

        function updateRankingDisplay() {
            const rankingDiv = document.getElementById('ranking');
            rankingDiv.innerHTML = '';

            const sortedRanking = Object.keys(ranking).sort((a, b) => ranking[b] - ranking[a]);

            sortedRanking.forEach((user, index) => {
                const div = document.createElement('div');
                div.classList.add('ranking-item');
                div.innerHTML = `
                    <span>${index + 1}位</span>
                    <span class="name">${user}</span>
                    <span class="points">${ranking[user]} Point</span>
                `;
                rankingDiv.appendChild(div);
            });
        }

        function updateParticipantListDisplay() {
            const participantListDiv = document.getElementById('participantList');
            participantListDiv.innerHTML = '';

            Object.keys(ranking).forEach((user) => {
                const div = document.createElement('div');
                div.classList.add('participant-item');
                div.innerHTML = `
                    <span class="name">${user}</span>
                    <span class="points">${ranking[user]} Point</span>
                    <button onclick="adjustPoints('${user}', 1)">+</button>
                    <button onclick="adjustPoints('${user}', -1)">-</button>
                `;
                participantListDiv.appendChild(div);
            });
        }

        function adjustPoints(username, delta) {
            if (ranking[username] !== undefined) {
                ranking[username] += delta;
                updateRankingDisplay();
                updateParticipantListDisplay();
            }
        }
    </script>
</body>
</html>
