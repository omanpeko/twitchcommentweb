<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TwitchæŠ•ç¥¨ã‚²ãƒ¼ã‚¸ï¼ˆFirebaseé€£å‹•ï¼‰</title>
  <style>
    :where([hidden]) { display: none !important; }
    :root{
      --fg:#ffffff;
      --red:#e63946; --red-bright:#ff7373; --red-deep:#8a1c26;
      --blue:#1e88e5; --blue-bright:#64b5f6; --blue-deep:#0c3c78;

      /* UIèƒŒæ™¯ã®ä¸é€æ˜åº¦ï¼ˆ85%ï¼‰ */
      --panel-alpha: 0.85;

      /* ãƒ•ã‚©ãƒ³ãƒˆï¼ˆå‰å›è¦æœ›åæ˜ æ¸ˆã¿ï¼‰ */
      --fs-title: clamp(22px, 2.8vw, 44px);
      --fs-rules: clamp(22px, 3.2vw, 56px);
      --fs-rules-sub: clamp(18px, 2.7vw, 36px);
      --fs-label: clamp(24px, 3vw, 48px);  /* ã€‡èµ¤/ã€‡é’ï¼ˆæ§ãˆã‚ï¼‰ */
      --fs-pct:   clamp(30px, 4.5vw, 60px);/* %ï¼ˆå¼·èª¿ï¼‰ */
      --fs-count: clamp(27px, 3.9vw, 36px);/* (ç¥¨)ï¼ˆå¼·èª¿ï¼‰ */
      --fs-timer: clamp(28px, 3.8vw, 60px);/* æ®‹ã‚Šæ™‚é–“ï¼ˆã‚„ã‚„å¤§ããï¼‰ */
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; background:transparent; color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      display:flex; align-items:center; justify-content:center; min-height:100vh;
      padding: 2.5vmin;
    }

    /* æ—¢å®šã¯ä½•ã‚‚è¦‹ã›ãªã„ */
    #rootHiddenGuard{ position:fixed; inset:0; display:block; background:transparent; }

    /* UIæœ¬ä½“ï¼ˆæœ€åˆã¯ hiddenï¼‰ */
    #frame{
      width:min(1200px, 96vw); /* â† æ¨ªæœ€å¤§1200pxã«å¤‰æ›´ */
      background: rgba(0,0,0,var(--panel-alpha));
      border-radius: 24px;
      padding: clamp(12px, 2vmin, 20px); /* å°‘ã—åœ§ç¸® */
      border: 2px solid rgba(255,255,255,0.9);
      backdrop-filter: blur(1px);
      display: grid;
      gap: clamp(10px, 1.6vmin, 20px); /* é–“éš”ã‚’å°‘ã—è©°ã‚ã‚‹ */
      grid-template-rows: auto auto 1fr auto;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆèµ¤/é’ã«è‰²ä»˜ã‘ã€ãƒœãƒ¼ãƒ«ãƒ‰ï¼‰ */
    #title{ 
      font-size: clamp(18px, 2vw, 32px); /* å°ã•ã‚ã«èª¿æ•´ */
      margin: 0; 
      font-weight:900; 
      letter-spacing:.02em; 
    }
    .t-red { color: var(--red);  font-weight:1000; }
    .t-blue{ color: var(--blue); font-weight:1000; }

    /* å‚åŠ æ–¹æ³•ï¼‹ã‚¿ã‚¤ãƒãƒ¼ */
    #meta{ 
      display:grid; 
      grid-template-columns: 1fr auto; 
      align-items:center; 
      gap: clamp(10px, 1.8vmin, 20px); /* å…¨ä½“ã«å°‘ã—è©°ã‚ã‚‹ */
    }
    #rules{ line-height:1.25; }
    .rule-head{
      display:inline-flex; align-items:center; gap:.5em; font-weight:900;
      border:2px solid rgba(255,255,255,0.95); border-radius:10px; /* ä¸¸ã¿å°ã•ã */
      padding:.15em .6em;
      margin-right:.5em; 
      font-size:clamp(16px, 1.8vw, 28px); /* â†“èª¿æ•´ */
      background: rgba(0,0,0,var(--panel-alpha));
    }
    .rule-body{ 
      font-size:clamp(16px, 1.8vw, 28px); 
      font-weight:900; 
    }
    .rule-sub{ 
      display:block; 
      margin-top:.25em; 
      font-size:clamp(14px, 1.6vw, 22px); 
      font-weight:800; 
    }
    #timer{
      font-size: clamp(18px, 2vw, 30px); /* èª¿æ•´ */
      font-weight:1000; letter-spacing:.02em;
      padding:.2em .6em; 
      border:2px solid rgba(255,255,255,0.95); 
      border-radius:10px; 
      background: rgba(0,0,0,var(--panel-alpha));
    }

    /* ã€‡èµ¤ï¼ã€‡é’ï¼ˆåŒä¸¦ã³ã€æ§ãˆã‚ã‚µã‚¤ã‚ºï¼‰ */
    #cards{ 
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap: clamp(10px, 2vmin, 20px); 
    }
    .card{
      background: rgba(0,0,0,var(--panel-alpha));
      border:2px solid rgba(255,255,255,0.9); 
      border-radius:12px; /* å°‘ã—å°ã•ã */
      padding: clamp(8px, 1.5vmin, 16px); /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ */
      display:grid; gap:.25em; 
      justify-items:center; align-items:center;
    }
    .label{ 
      display:flex; align-items:center; gap:.4em; 
      font-size:clamp(18px, 2vw, 28px); 
      font-weight:1000; 
    }
    .dot{ width:1em; height:1em; border-radius:999px; display:inline-block; }
    .dot.red{ background:var(--red); } .dot.blue{ background:var(--blue); }
    .pct{ 
      font-size:clamp(28px, 4vw, 50px); 
      font-weight:900; 
    }
    .count{ 
      font-size:clamp(18px, 2vw, 26px); 
      font-weight:800; 
      font-variant-numeric:tabular-nums; 
    }

    /* ã‚²ãƒ¼ã‚¸ï¼šã»ã‚“ã®ã‚Šæ–œã‚ã‚°ãƒ©ãƒ‡ã§æš—ããªã‚‹ï¼ˆã‹ã£ã“ã‚ˆãï¼‰ */
    #bars{
      width:100%; 
      height: clamp(40px, 8vmin, 90px); /* é«˜ã•ã‚’èª¿æ•´ */
      border:2px solid rgba(255,255,255,0.95); 
      border-radius:14px; /* å°‘ã—ä¸¸ã¿æ¸› */
      overflow:hidden;
      background: rgba(0,0,0,var(--panel-alpha)); 
      position:relative; 
      display:flex;
    }
    #bars::before{
      content:""; 
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.03));
      pointer-events:none; 
      mix-blend-mode: screen;
    }
    .bar{ height:100%; transition:width .35s ease; position:relative; }
    #redBar{ 
      width:50%; 
      background: linear-gradient(135deg, var(--red-bright) 0%, var(--red) 55%, var(--red-deep) 100%); 
    }
    #blueBar{ 
      width:50%; 
      background: linear-gradient(135deg, var(--blue-bright) 0%, var(--blue) 55%, var(--blue-deep) 100%); 
    }

    /* çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #result{ 
      position:fixed; inset:0; align-items:center; justify-content:center;
      background: rgba(0,0,0,.65); z-index: 10; padding: 3vmin; 
    }
    #resultCard {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%); /* ä¸­å¤®é…ç½® */
      width: 60%;   /* æ¨ªå¹…ç¸®å° */
      height: 60%;  /* é«˜ã•ç¸®å° */
      background: rgba(0,0,0,0.9);
      border: 2px solid rgba(255,255,255,0.95);
      border-radius: 16px; /* ä¸¸ã¿æ¸› */
      padding: 2vmin;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
    }
    #resultTitle{ font-size: var(--fs-rules-sub); margin:0; }
    #winner{ font-size: clamp(40px, 6vw, 100px); font-weight: 1000; margin: .1em 0; }
    #breakdown{ font-size: clamp(18px, 2.5vw, 32px); }

    /* ç®¡ç†è€…ç”¨ãƒœã‚¿ãƒ³ */
    #adminPanel {
      position: fixed;
      top: 8px; left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 2000;
    }
    #adminPanel button {
      padding: 6px 12px;
      font-size: 16px;
      font-weight: bold;
    }

    #winnerText {
      font-size: 4rem;   /* åŠåˆ†ãã‚‰ã„ã®å¤§ãã• */
      text-align: center;
      line-height: 1.6;
    }
    .highlight-red {
      color: red;
      font-weight: bold;
    }
    .highlight-blue {
      color: blue;
      font-weight: bold;
    }

    /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .fade1s {
      opacity: 0;
      pointer-events: none;   /* éè¡¨ç¤ºæ™‚ã¯æ“ä½œä¸å¯ */
      transition: opacity 0.7s ease;
    }
    .fade1s.show {
      opacity: 1;
      pointer-events: auto;   /* è¡¨ç¤ºä¸­ã ã‘æ“ä½œå¯èƒ½ */
    }

    /* ===============================
      ğŸ® ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆä¸­å¤®é…ç½®ï¼‰
    ==================================*/
    #teamsContainer {
      position: fixed;
      top: 20px;              /* ä¸Šç«¯ã‹ã‚‰20px */
      left: 50%;
      transform: translateX(-50%); /* Xè»¸ã ã‘ä¸­å¤®ã« */
      display: flex;
      justify-content: center; /* ä¸­å¤®å¯„ã› */
      align-items: flex-start;  /* ä¸Šç«¯æƒãˆ */
      width: 100%;
      height: auto;
      pointer-events: none;
      z-index: 10;
    }

    /* ãƒãƒ¼ãƒ ãƒœãƒƒã‚¯ã‚¹ï¼šèµ¤ãƒ»é’ã‚’å·¦å³ã«é…ç½® */
    .team-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 100px; /* èµ¤é’ã®é–“éš” */
    }

    /* ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤ºï¼ˆç¸¦1åˆ—ãƒ»ä¸­å¤®æƒãˆï¼‰ */
    .members {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    /* å„ãƒ¡ãƒ³ãƒãƒ¼ */
    .member {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      color: white;
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³ */
    .member .icon {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.9);
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    /* åå‰ã¨ãƒ©ãƒ³ã‚¯ */
    .member .name {
      font-size: 15px;
      font-weight: 800;
      margin-top: 6px;
    }

    .member .rank {
      margin-top: 3px;
      width: 50px;
      opacity: 0.9;
    }



  </style>
</head>
<body>
  <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ -->
  <div id="rootHiddenGuard"></div>

  <!-- ç®¡ç†è€…ç”¨ãƒœã‚¿ãƒ³ -->
  <div id="adminPanel" hidden>
    <button id="btnStart">æŠ•ç¥¨é–‹å§‹</button>
    <button id="btnRestart">ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="btnReset">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="btnRed">èµ¤ã«ï¼‹1</button>
    <button id="btnBlue">é’ã«ï¼‹1</button>
    <button id="btnShow">UIè¡¨ç¤º</button>
    <button id="btnHide">UIéè¡¨ç¤º</button>
    <button id="btnEnd">çµ‚äº†</button>
    <button id="btnRedWin">èµ¤å‹ã¡</button>
    <button id="btnBlueWin">é’å‹ã¡</button>
  </div>

  <!-- ğŸ§© ãƒãƒ¼ãƒ è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="teamsContainer" class="fade1s show">
    <div id="teamRed" class="team-box">
      <div class="members" id="membersRed"></div>
    </div>

    <div id="teamBlue" class="team-box">
      <div class="members" id="membersBlue"></div>
    </div>
  </div>



  <!-- UIæœ¬ä½“ï¼ˆFirestore visible=true ã§è¡¨ç¤ºï¼‰ -->
  <div id="frame" class="fade1s">
    <p id="title"><span class="t-red">èµ¤ãƒãƒ¼ãƒ </span> VS <span class="t-blue">é’ãƒãƒ¼ãƒ </span>ã€€ã©ã¡ã‚‰ãŒå‹ã¤ã‹äºˆæƒ³ã—ã‚ˆã†ï¼â€” ã‚³ãƒ¡ãƒ³ãƒˆã§å‚åŠ </p>

    <div id="meta">
      <div id="rules">
        <span class="rule-head">å‚åŠ æ–¹æ³•</span>
        <span class="rule-body">ãƒãƒ£ãƒƒãƒˆã§ <b>!èµ¤</b> ã¾ãŸã¯ <b>!é’</b> ã¨å…¥åŠ›ï¼</span>
        <span class="rule-sub">ï¼ˆæŠ•ç¥¨ã®å–ã‚Šæ¶ˆã—ï¼å¤‰æ›´OKãƒ»å¸¸ã«æœ€æ–°ç¥¨ãŒæœ‰åŠ¹ï¼‰</span>
      </div>
      <div id="timer">æ®‹ã‚Š: 3:00</div>
    </div>

    <div id="cards">
      <div class="card">
        <div class="label"><span class="dot red"></span><span>èµ¤</span></div>
        <div class="pct" id="redPct">50%</div>
        <div class="count" id="redCount">(0ç¥¨)</div>
      </div>
      <div class="card">
        <div class="label"><span class="dot blue"></span><span>é’</span></div>
        <div class="pct" id="bluePct">50%</div>
        <div class="count" id="blueCount">(0ç¥¨)</div>
      </div>
    </div>

    <div id="bars">
      <div id="redBar" class="bar"></div>
      <div id="blueBar" class="bar"></div>
    </div>
  </div>

  <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="result" class="fade1s">
    <div id="resultCard">
      <p id="resultTitle" style="margin-top: 3em;">æŠ•ç¥¨çµ‚äº†ï¼å‹è€…ã¯â€”â€”</p>
      <p id="winner"></p>
      <p id="breakdown"></p>
    </div>
  </div>

  <!-- Firebase + Firestore + ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <script type="module">
    import {
      getFirestore,
      doc,
      onSnapshot,
      setDoc,
      updateDoc,
      getDoc,
      getDocs,
      serverTimestamp,
      increment,
      collection,
      addDoc,
      query,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

    // ==== Firebase Config ====
    const firebaseConfig = {
      apiKey: "AIzaSyCVTEvN3EqebNOLlFdGfGA5612VkcRRbsQ",
      authDomain: "twitchchatdatabase.firebaseapp.com",
      projectId: "twitchchatdatabase",
      storageBucket: "twitchchatdatabase.firebasestorage.app",
      messagingSenderId: "861792479829",
      appId: "1:861792479829:web:9afe238a03f6527a55c2dc",
      measurementId: "G-3N10HW4NEY"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const pollsCol = collection(db, "polls");

    // ==== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ====
    function parseLaunchParams() {
      const search = window.location.search.toLowerCase();
      const params = new URLSearchParams(window.location.search);

      // ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆä¸¡æ–¹å«ã‚“ã§OKï¼‰
      const mode = {
        viewer: search.includes("viewer"),
        log: search.includes("log"),
      };

      // ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
      const urlParam = params.get("url");
      const channelList = [];
      if (urlParam) {
        for (const u of urlParam.split(",")) {
          const ch = extractChannelName(u.trim());
          if (ch) channelList.push(ch);
        }
      }

      return { mode, channelList };
    }
    function extractChannelName(url) {
      if (!url) return null;
      const m = String(url).match(/twitch\.tv\/([^\/?#&]+)/i);
      return m ? m[1] : null;
    }

    let currentPollRef = null;   // æœ€æ–°Pollã®DocRef
    let currentPollId  = null;   // æœ€æ–°Pollã®ID

    // === æœ€æ–°pollã‚’ç›£è¦–ã™ã‚‹ ===
    function watchLatestPoll(viewerMode){
      const q = query(collection(db,"polls"), orderBy("createdAt","desc"), limit(1));
      onSnapshot(q, (snap)=>{
        if (snap.empty) return;
        const docSnap = snap.docs[0];
        currentPollRef = docSnap.ref;
        currentPollId  = docSnap.id;

        const data = docSnap.data() || {};

        // ç¥¨æ›´æ–°
        const v = data.votes || {red:0, blue:0};
        updateBars(v.red, v.blue);

        // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
        if (data.endTime) {
          endTime = data.endTime;
        }

        // viewerãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã ã‘ visible åˆ¶å¾¡
        if (viewerMode) {
          const teamContainer = document.getElementById("teamsContainer");
          
          // âœ… UIè¡¨ç¤ºåˆ¶å¾¡
          if (data.visible) {
            frameEl.classList.add("show");
            teamContainer.classList.add("show");
            guardEl.style.display = "none";

          } else {
            frameEl.classList.remove("show");
            teamContainer.classList.remove("show");
            guardEl.style.display = "block";
          }
        }
      });
    }

    // ==== æŠ•ç¥¨ãƒ­ã‚¸ãƒƒã‚¯ ====
    let ws = null, finished = false;
    const userVotes = Object.create(null);
    let endTime = null;

    const frameEl = document.getElementById("frame");
    const guardEl = document.getElementById("rootHiddenGuard");
    const resultEl = document.getElementById("result");
    const winnerEl = document.getElementById("winner");
    const breakdownEl = document.getElementById("breakdown");
    const redBar = document.getElementById("redBar");
    const blueBar = document.getElementById("blueBar");
    const redPctEl = document.getElementById("redPct");
    const bluePctEl= document.getElementById("bluePct");
    const redCntEl = document.getElementById("redCount");
    const blueCntEl= document.getElementById("blueCount");
    const timerEl  = document.getElementById("timer");

    // ==== WebSocketæ¥ç¶šï¼ˆè¤‡æ•°JOIN + logå¯¾å¿œï¼‰ ====
    function connectMultipleChannels(channels, mode) {
      if (!channels.length) return;

      ws = new WebSocket("wss://irc-ws.chat.twitch.tv:443");

      ws.onopen = () => {
        ws.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");
        ws.send("PASS SCHMOOPIIE");
        ws.send("NICK justinfan" + Math.floor(Math.random() * 100000));

        for (const ch of channels) {
          ws.send("JOIN #" + ch);
          console.log(`âœ… JOINED: #${ch}`);
        }
      };

      ws.onmessage = (ev) => {
        const raw = ev.data.trim();
        if (raw.startsWith("PING")) { ws.send("PONG :tmi.twitch.tv"); return; }

        for (const line of raw.split("\n")) {
          if (!line.includes("PRIVMSG")) continue;

          const msg  = getMessageText(line);
          const tags = parseTags(line);
          const uid  = getStableUserId(tags, line);
          if (!uid) continue;
          const displayName = tags["display-name"] || uid;
          const channel = (line.match(/#([a-zA-Z0-9_]+)/) || [])[1] || "unknown";

          // ğŸ’¬ Logãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ãªã‚‰å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›
          if (mode.log) console.log(`[${channel}] ${displayName}: ${msg}`);

          // viewerã¾ãŸã¯logãƒ¢ãƒ¼ãƒ‰ã®ã©ã¡ã‚‰ã‹ãŒæœ‰åŠ¹ãªã‚‰æŠ•ç¥¨å¯èƒ½
          if (!mode.viewer && !mode.log) return;
          if (finished || !currentPollId) return;

          let vote = null;
          // æŠ•ç¥¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¤å®šï¼ˆåŠè§’/å…¨è§’ã€åˆ¥è¡¨è¨˜å¯¾å¿œï¼‰
          const normalizedMsg = msg.toLowerCase().replace(/[ï¼!]/g, "!");

          // !èµ¤ / !ã‚ã‹ / !aka / !red ã‚’ã™ã¹ã¦èªè­˜
          if (/! *(èµ¤|ã‚ã‹|aka|red)/i.test(normalizedMsg)) {
            vote = "red";
          }
          // !é’ / !ã‚ãŠ / !ao / !blue ã‚’ã™ã¹ã¦èªè­˜
          else if (/! *(é’|ã‚ãŠ|ao|blue)/i.test(normalizedMsg)) {
            vote = "blue";
          }
          if (!vote) continue;

          // âœ… æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ç™»éŒ²
          registerOrChangeVote(currentPollId, uid, displayName, vote);
        }
      };
    }

    function getMessageText(line){
      const i = line.indexOf(" PRIVMSG ");
      if (i < 0) return "";
      const part = line.slice(i);
      const c = part.indexOf(" :");
      return c >= 0 ? part.slice(c+2) : "";
    }
    function parseTags(line){
      const firstSpace = line.indexOf(" ");
      const tagsPart = firstSpace > 0 ? line.slice(0, firstSpace) : "";
      const obj = {};
      for (const kv of tagsPart.split(";")) {
        const [k, v] = kv.split("=");
        if (k) obj[k] = v || "";
      }
      return obj;
    }
    function getStableUserId(tags, line){
      if (tags["user-id"]) return tags["user-id"];
      if (tags["login"]) return tags["login"];
      const m = line.match(/^[^ ]+\s:([^!]+)!/);
      if (m) return m[1].toLowerCase();
      return null;
    }


  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¥¨å‡¦ç†
  async function registerOrChangeVote(pollId, uid, color, displayName) {
    const pollRef = doc(db, "polls", pollId);
    const pollSnap = await getDoc(pollRef);

    if (!pollSnap.exists()) return;
    const pollData = pollSnap.data();

    if (pollData.finished || Date.now() > pollData.endTime) {
      console.log("æŠ•ç¥¨å—ä»˜çµ‚äº†æ¸ˆã¿ã§ã™");
      return;
    }

    const voterRef = doc(db, "polls", pollId, "voters", displayName);
    const voterSnap = await getDoc(voterRef);

    if (!voterSnap.exists()) {
      await setDoc(voterRef, { uid: uid, choice: color });
      await updateDoc(pollRef, { [`votes.${color}`]: increment(1) });
    } else {
      const prevColor = voterSnap.data().choice;
      if (prevColor !== color) {
        await updateDoc(pollRef, {
          [`votes.${prevColor}`]: increment(-1),
          [`votes.${color}`]: increment(1)
        });
        await setDoc(voterRef, { uid: uid, choice: color });
      }
    }
  }



    function updateBars(red, blue){
      const total = red + blue;
      let redPct = total > 0 ? Math.round((red/total)*1000)/10 : 50;
      redBar.style.width  = redPct + "%";
      blueBar.style.width = (100 - redPct) + "%";
      redPctEl.textContent  = redPct.toFixed(1).replace(/\.0$/,"") + "%";
      bluePctEl.textContent = (100-redPct).toFixed(1).replace(/\.0$/,"") + "%";
      redCntEl.textContent  = `(${red}ç¥¨)`;
      blueCntEl.textContent = `(${blue}ç¥¨)`;
    }

    // 1ç§’ã”ã¨ã«æ®‹ã‚Šæ™‚é–“ã‚’è¡¨ç¤º
    setInterval(()=>{
      if (endTime) {
        const remainingMs = endTime - Date.now();
        const remainingSec = Math.max(0, Math.floor(remainingMs/1000));
        renderTime(remainingSec);
      }
    }, 1000);

    function renderTime(sec){
      const m = String(Math.floor(sec/60));
      const s = String(sec%60).padStart(2,"0");
      timerEl.textContent = sec > 0 ? `æ®‹ã‚Š: ${m}:${s}` : "çµ‚äº†ï¼";
    }

    // ==== ç®¡ç†è€…ãƒœã‚¿ãƒ³ ====
    const { mode } = parseLaunchParams();
    const isAdmin = !mode.viewer && !mode.log;
    document.getElementById("adminPanel").hidden = !isAdmin;

    // ==== æŠ•ç¥¨é–‹å§‹ï¼ˆæ–°ã—ã„pollã‚’ä½œã‚‹ï¼‰====
    document.getElementById("btnStart").addEventListener("click", async ()=>{
      // æ—¥æ™‚ã‹ã‚‰IDç”Ÿæˆ
      const now = new Date();
      const id = now.toISOString().replace(/[:.]/g,"-"); // 2025-10-02T14-33-15-123Z â†’ 2025-10-02T14-33-15-123Z
      const pollRef = doc(collection(db,"polls"), id);

      await setDoc(pollRef, {
        visible: true,
        votes: { red: 0, blue: 0 },
        endTime: Date.now() + 180000,
        createdAt: serverTimestamp()
      });

      currentPollRef = pollRef;
      currentPollId  = id;
    });

    // ==== ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ ====
    document.getElementById("btnRestart").addEventListener("click", async ()=>{
      if (!currentPollRef) return;
      await updateDoc(currentPollRef, { endTime: Date.now() + 180000 });
    });

    // ==== å…¨ãƒªã‚»ãƒƒãƒˆ ====
    document.getElementById("btnReset").addEventListener("click", async ()=>{
      if (!currentPollRef) return;
      await updateDoc(currentPollRef, {
        votes: { red: 0, blue: 0 },
        endTime: Date.now() + 180000
      });
    });

    function setupLongPress(btnId, color) {
      const btn = document.getElementById(btnId);
      let intervalId = null, timeoutId = null, isPressed = false;
      const startPress = async () => {
        isPressed = true;
        if (currentPollRef) await updateDoc(currentPollRef, { [`votes.${color}`]: increment(1) });
        timeoutId = setTimeout(() => {
          if (isPressed) {
            intervalId = setInterval(async ()=>{
              if (!isPressed || !currentPollRef) return;
              await updateDoc(currentPollRef, { [`votes.${color}`]: increment(1) });
            },200);
          }
        },1000);
      };
      const endPress = ()=>{
        isPressed = false;
        clearTimeout(timeoutId);
        clearInterval(intervalId);
      };
      btn.addEventListener("mousedown", startPress);
      btn.addEventListener("mouseup", endPress);
      btn.addEventListener("mouseleave", endPress);
    }
    setupLongPress("btnRed","red");
    setupLongPress("btnBlue","blue");

    document.getElementById("btnShow").addEventListener("click", async ()=>{
      if (!currentPollRef) return;
      await updateDoc(currentPollRef, { visible:true });
    });
    document.getElementById("btnHide").addEventListener("click", async ()=>{
      if (!currentPollRef) return;
      await updateDoc(currentPollRef, { visible:false });
    });

    // ==== èµ·å‹•æ™‚å‡¦ç† ====
    window.addEventListener("load", () => {
      const { mode, channelList } = parseLaunchParams();

      if (channelList.length) connectMultipleChannels(channelList, mode);

      // viewer or logã©ã¡ã‚‰ã‹ã‚’å«ã‚“ã§ã„ã‚Œã°UIèµ·å‹•
      if (mode.viewer || mode.log) {
        watchLatestPoll(true);
      } else {
        // adminãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        watchLatestPoll(false);
        frameEl.classList.add("show");
        guardEl.style.display = "none";
      }

      // âœ… VALORANTãƒãƒ¼ãƒ å¤‰æ›´ç›£è¦–ã‚’é–‹å§‹ï¼ˆUIè¡¨ç¤ºã¨ç„¡é–¢ä¿‚ï¼‰
      watchValorantPlayers();

      console.log(`ğŸ® MODE: viewer=${mode.viewer}, log=${mode.log}`);
      // âœ… ãƒãƒ¼ãƒ èª­ã¿è¾¼ã¿
      loadValorantTeams();
    });

    // ==== çµ‚äº†ãƒœã‚¿ãƒ³ ====
    document.getElementById("btnEnd").addEventListener("click", async ()=>{
      if (!currentPollRef) return;

      const now = Date.now();

      // Firestoreæ›´æ–°
      await updateDoc(currentPollRef, {
        finished: true,
        endTime: now
      });

      // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚‚çµ‚äº†æ‰±ã„ã«
      finished = true;
      endTime = now;
    });

  // çµæœè¡¨ç¤ºé–¢æ•°ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã—ã¦10ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼‰
  function showResult(html) {
    winnerEl.innerHTML = html;
    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
    resultEl.classList.add("show");

    // 10ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    setTimeout(() => {
      resultEl.classList.remove("show");
    }, 10000);
  }

  // ==== èµ¤å‹ã¡ ====
  document.getElementById("btnRedWin").addEventListener("click", async ()=>{
    if (!currentPollRef) return;

    const votersRef = collection(currentPollRef, "voters");
    const voterSnaps = await getDocs(votersRef);
    const redVoters = voterSnaps.docs
      .map(d => ({ name: d.id, ...d.data() }))
      .filter(v => v.choice === "red");

    let winnerName = "è©²å½“è€…ãªã—";
    if (redVoters.length > 0) {
      const rand = Math.floor(Math.random() * redVoters.length);
      winnerName = redVoters[rand].name;
    }

    await updateDoc(currentPollRef, {
      winner: winnerName,
      finished: true
    });

    // è¡¨ç¤ºï¼ˆèµ¤æ–‡å­—ã§å¼·èª¿ã€ç„¡é§„ãªæ”¹è¡Œãªã—ï¼‰
    showResult(
      `<div id="winnerText">
        <span class="highlight-red">èµ¤ãƒãƒ¼ãƒ ã®å‹åˆ©ï¼</span><br>
        ã€ ${winnerName} ã€‘ã•ã‚“ãŒå½“é¸ã—ã¾ã—ãŸï¼ğŸ‰<br>
        ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
      </div>`
    );
  });

  // ==== é’å‹ã¡ ====
  document.getElementById("btnBlueWin").addEventListener("click", async ()=>{
    if (!currentPollRef) return;

    const votersRef = collection(currentPollRef, "voters");
    const voterSnaps = await getDocs(votersRef);
    const blueVoters = voterSnaps.docs
      .map(d => ({ name: d.id, ...d.data() }))
      .filter(v => v.choice === "blue");

    let winnerName = "è©²å½“è€…ãªã—";
    if (blueVoters.length > 0) {
      const rand = Math.floor(Math.random() * blueVoters.length);
      winnerName = blueVoters[rand].name;
    }

    await updateDoc(currentPollRef, {
      winner: winnerName,
      finished: true
    });

    // è¡¨ç¤ºï¼ˆé’æ–‡å­—ã§å¼·èª¿ã€ç„¡é§„ãªæ”¹è¡Œãªã—ï¼‰
    showResult(
      `<div id="winnerText">
        <span class="highlight-blue">é’ãƒãƒ¼ãƒ ã®å‹åˆ©ï¼</span><br>
        ã€ ${winnerName} ã€‘ã•ã‚“ãŒå½“é¸ã—ã¾ã—ãŸï¼ğŸ‰<br>
        ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
      </div>`
    );
  });

  // =======================================================
  // ğŸ¯ VALORANT ã‚¢ã‚¿ãƒƒã‚«ãƒ¼ï¼†ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼ã® nameå¤‰æ›´ç›£è¦–
  // =======================================================

  // å‰å›ã®nameã‚’ä¿å­˜ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆä¸¡ãƒãƒ¼ãƒ å…±é€šï¼‰
  let lastPlayerNames = {};

  function watchValorantPlayers() {
    console.log("ğŸ‘€ Firestoreç›£è¦–é–‹å§‹ï¼šã‚¢ã‚¿ãƒƒã‚«ãƒ¼ï¼†ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼");

    // ç›£è¦–å¯¾è±¡ãƒãƒ¼ãƒ ä¸€è¦§
    const teamPaths = [
      ["ã‚¢ã‚¿ãƒƒã‚«ãƒ¼", "red"],
      ["ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼", "blue"]
    ];

    teamPaths.forEach(([teamName, teamKey]) => {
      const teamRef = collection(db, "TwitchChatDatabase", "VALORANTteam", teamName);

      // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’è¨­å®š
      onSnapshot(teamRef, (snapshot) => {
        let nameChanged = false;

        snapshot.forEach((doc) => {
          const data = doc.data();
          const docId = `${teamKey}_${doc.id}`; // ä¾‹: "red_player1"
          const newName = data.name || "";

          // player1ã€œ5 ã®ã¿ãƒã‚§ãƒƒã‚¯
          if (!/^player[1-5]$/.test(doc.id)) return;

          const oldName = lastPlayerNames[docId];

          // åˆå›ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç™»éŒ²ã®ã¿
          if (oldName === undefined) {
            lastPlayerNames[docId] = newName;
            console.log(`ğŸ“˜ åˆå›ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${docId} = ${newName}`);
            return;
          }

          // åå‰å¤‰æ›´ã‚’æ¤œçŸ¥
          if (oldName !== newName) {
            console.log(`ğŸ” ${teamName} ã® ${doc.id}: nameå¤‰æ›´æ¤œå‡º â†’ "${oldName}" â†’ "${newName}"`);
            lastPlayerNames[docId] = newName;
            nameChanged = true;
          }
        });

        // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å†èª­ã¿è¾¼ã¿
        if (nameChanged) {
          console.log(`âœ… ${teamName} å´ã§å¤‰æ›´ã‚ã‚Š â†’ loadValorantTeams() å®Ÿè¡Œ`);
          loadValorantTeams();
        }
      }, (error) => {
        console.error(`âŒ Firestoreç›£è¦–ã‚¨ãƒ©ãƒ¼ (${teamName}):`, error);
      });
    });
  }



  // ==================================================
  // ğŸ¯ Firestoreã‹ã‚‰VALORANTãƒãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤º
  // ==================================================
  async function loadValorantTeams() {
    try {
      const redBox = document.getElementById("membersRed");
      const blueBox = document.getElementById("membersBlue");

      redBox.innerHTML = "";
      blueBox.innerHTML = "";

      const docRef = doc(db, "TwitchChatDatabase", "VALORANTteam");

      // å„ãƒãƒ¼ãƒ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      const redSnap = await getDocs(collection(docRef, "ã‚¢ã‚¿ãƒƒã‚«ãƒ¼"));
      const blueSnap = await getDocs(collection(docRef, "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼"));

      const createMemberCard = (p) => `
        <div class="member">
          <img src="${p.icon}" class="icon" alt="${p.name}">
          <div class="name">${p.name}</div>
          <img src="${p.rankImg}" class="rank" alt="${p.rank}">
        </div>
      `;

      redSnap.forEach(d => {
        const data = d.data();
        redBox.insertAdjacentHTML("beforeend", createMemberCard(data));
      });

      blueSnap.forEach(d => {
        const data = d.data();
        blueBox.insertAdjacentHTML("beforeend", createMemberCard(data));
      });

      console.log("âœ… ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
      // ãƒãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã å¾Œã«é…ç½®
      positionMembersAbsolute();
    } catch (err) {
      console.error("âŒ ãƒãƒ¼ãƒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    }
  }

  // =============================================
  // ğŸ¯ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä¸­å¤®åŸºæº–ãƒ»å›ºå®šåº§æ¨™é…ç½®
  // =============================================
  function positionMembersAbsolute() {
    const redTeam = document.querySelectorAll("#membersRed .member");
    const blueTeam = document.querySelectorAll("#membersBlue .member");

    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight / 2 -400; // å…¨å“¡å…±é€šã®é«˜ã•

    // --- èµ¤ãƒãƒ¼ãƒ  ---
    const redOffsets = [160, 280, 400, 520, 640]; // ä¸­å¤®ã‹ã‚‰å·¦æ–¹å‘
    redTeam.forEach((el, i) => {
      const x = centerX - redOffsets[i];
      el.style.position = "fixed";
      el.style.left = `${x}px`;
      el.style.top = `${centerY}px`;
      el.style.transform = "translate(-50%, -50%)";
    });

    // --- é’ãƒãƒ¼ãƒ  ---
    const blueOffsets = [160, 280, 400, 520, 640]; // ä¸­å¤®ã‹ã‚‰å³æ–¹å‘
    blueTeam.forEach((el, i) => {
      const x = centerX + blueOffsets[i];
      el.style.position = "fixed";
      el.style.left = `${x}px`;
      el.style.top = `${centerY}px`;
      el.style.transform = "translate(-50%, -50%)";
    });
  }







  </script>

</body>
</html>
