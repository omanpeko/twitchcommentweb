<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TwitchæŠ•ç¥¨ã‚²ãƒ¼ã‚¸ï¼ˆFirebaseé€£å‹•ï¼‰</title>
  <style>
    /* =====================================================
      ğŸ’¡ åŸºæœ¬è¨­å®šãƒ»å…±é€š
      ===================================================== */
    :where([hidden]) { display: none !important; }

    * {
      box-sizing: border-box;
    }

    /* ãƒšãƒ¼ã‚¸å…¨ä½“è¨­å®šï¼ˆèƒŒæ™¯é€æ˜ãƒ»ä¸­å¤®é…ç½®ï¼‰ */
    body {
      margin: 0;
      background: transparent;
      color: #FFFFFF;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    /* =====================================================
      ğŸ§± èƒŒæ™¯ãƒ–ãƒ­ãƒƒã‚¯åˆ¶å¾¡ï¼ˆUIéè¡¨ç¤ºæ™‚ã®ã‚¬ãƒ¼ãƒ‰ï¼‰
      ===================================================== */
    #rootHiddenGuard {
      position: fixed;
      inset: 0;
      display: block;
      background: transparent;
    }

    /* =====================================================
      âš™ï¸ ç®¡ç†è€…ãƒœã‚¿ãƒ³ãƒ‘ãƒãƒ«
      ===================================================== */
    #adminPanel {
      position: fixed;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 2000;
    }

    /* ç®¡ç†è€…ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    #adminPanel button {
      padding: 6px 12px;
      font-size: 16px;
      font-weight: bold;
    }

    /* =====================================================
      ğŸ”´ğŸ”µ æŠ•ç¥¨ã‚²ãƒ¼ã‚¸æœ¬ä½“
      ===================================================== */
    #overlayGauge {
      position: fixed;
      left: 269px;       /* ã‚²ãƒ¼ã‚¸ã®å·¦ç«¯ä½ç½® */
      top: 643px;        /* ã‚²ãƒ¼ã‚¸ã®ç¸¦ä½ç½® */
      width: 1382px;     /* 1651 - 269 */
      height: 32px;      /* 675 - 643 */
      z-index: 5000;
      pointer-events: none;
    }

    /* èµ¤ãƒ»é’ã‚²ãƒ¼ã‚¸å…±é€šè¨­å®š */
    #overlayRed,
    #overlayBlue {
      position: absolute;
      top: 0;
      height: 100%;
      transition: width 0.35s ease;  /* ã‚²ãƒ¼ã‚¸ãŒæ»‘ã‚‰ã‹ã«å‹•ã */
    }

    /* èµ¤ã‚²ãƒ¼ã‚¸ */
    #overlayRed {
      left: 0;
      background: #CD0909;
      width: 50%;
    }

    /* é’ã‚²ãƒ¼ã‚¸ */
    #overlayBlue {
      right: 0;
      background: #1752EB;
      width: 50%;
    }

    /* å¢ƒç•Œç·šï¼ˆä¸­å¤®ã®é‡‘è‰²ãƒ©ã‚¤ãƒ³ï¼‰ */
    #overlayBorder {
      position: absolute;
      top: 0;
      width: 1px;
      height: 100%;
      background: #CFAF74;
      transition: left 0.35s ease;
    }

    /* =====================================================
      ğŸ’¬ ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ãƒ»ç¥¨æ•°è¡¨ç¤º
      ===================================================== */

    /* èµ¤ãƒãƒ¼ãƒ è¡¨ç¤ºä½ç½®ï¼ˆä¸­å¤®æƒãˆï¼‰ */
    #overlayRedTextBox {
      position: fixed;
      left: 692px;
      top: 515px;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #FFFFFF;
      pointer-events: none;
      z-index: 5001;
      font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
    }

    /* é’ãƒãƒ¼ãƒ è¡¨ç¤ºä½ç½®ï¼ˆä¸­å¤®æƒãˆï¼‰ */
    #overlayBlueTextBox {
      position: fixed;
      left: 1236px;
      top: 515px;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #FFFFFF;
      pointer-events: none;
      z-index: 5001;
      font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
    }

    /* ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼ˆå¤§ãã„æ–‡å­—ï¼‰ */
    .pct-text {
      font-size: 70px;
      font-weight: 900;
      line-height: 1;
    }

    /* ç¥¨æ•°ï¼ˆä¸‹ã«å°ã•ãè¡¨ç¤ºï¼‰ */
    .count-text {
      font-size: 30px;
      font-weight: 900;
      line-height: 1.1;
      margin-top: 8px;
    }

    /* èµ¤å´ã®ãƒã‚ªãƒ³ç™ºå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    #overlayRedTextBox .pct-text,
    #overlayRedTextBox .count-text {
      text-shadow:
        0 0 6px #E11212,
        0 0 12px #E11212,
        0 0 18px rgba(225,18,18,0.8);
    }

    /* é’å´ã®ãƒã‚ªãƒ³ç™ºå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    #overlayBlueTextBox .pct-text,
    #overlayBlueTextBox .count-text {
      text-shadow:
        0 0 6px #0A3FC9,
        0 0 12px #0A3FC9,
        0 0 18px rgba(10,63,201,0.8);
    }

    /* =====================================================
      â±ï¸ æ®‹ã‚Šæ™‚é–“è¡¨ç¤º
      ===================================================== */
    #overlayTimerBox {
      position: fixed;
      left: 960px;       /* ä¸­å¤® */
      top: 495px;        /* ä½ç½®æŒ‡å®š */
      transform: translate(-50%, -50%);
      text-align: center;
      color: #FFFFFF;
      z-index: 5002;
      pointer-events: none;
      font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
    }

    /* ã€Œæ®‹ã‚Šæ™‚é–“ã€ãƒ©ãƒ™ãƒ«éƒ¨åˆ† */
    #overlayTimerLabel {
      font-size: 27px;
      font-weight: 900;
      line-height: 1;
    }

    /* å®Ÿéš›ã®ã‚«ã‚¦ãƒ³ãƒˆï¼ˆä¾‹ï¼š3:24ï¼‰ */
    #overlayTimerValue {
      margin-top: 12px;
      font-size: 48px;
      font-weight: 900;
    }

    /* ===============================
    ğŸ¨ èƒŒæ™¯ç”»åƒ
    =============================== */
    #overlayBackground {
      position: fixed;
      top: 0;
      left: 0;
      width: auto;
      height: auto;
      max-width: none;
      max-height: none;
      z-index: 100; /* UIã®ä¸‹ã«ã—ãŸã„å ´åˆã¯å°ã•ã‚ã«èª¿æ•´ */
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.7s ease;
    }
    #overlayBackground.show {
      opacity: 1;
    }

    /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .fade1s {
      opacity: 0;
      pointer-events: none;   /* éè¡¨ç¤ºæ™‚ã¯æ“ä½œä¸å¯ */
      transition: opacity 0.7s ease;
    }
    .fade1s.show {
      opacity: 1;
      pointer-events: auto;   /* è¡¨ç¤ºä¸­ã ã‘æ“ä½œå¯èƒ½ */
    }


  </style>
</head>
<body>
  <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ -->
  <div id="rootHiddenGuard"></div>

  <!-- èƒŒæ™¯ç”»åƒ -->
  <img id="overlayBackground" 
      src="https://raw.githubusercontent.com/omanpeko/PekoriBot/main/%E3%81%BA%E3%81%93%E3%82%AB%E3%82%B9valorant%E8%83%8C%E6%99%AF.png"
      class="fade1s"
      alt="èƒŒæ™¯"
  >

  <!-- ç®¡ç†è€…ç”¨ãƒœã‚¿ãƒ³ -->
  <div id="adminPanel" hidden>
    <button id="btnStart">æŠ•ç¥¨é–‹å§‹</button>
    <button id="btnRestart">ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="btnReset">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="btnRed">èµ¤ã«ï¼‹1</button>
    <button id="btnBlue">é’ã«ï¼‹1</button>
    <button id="btnShow">UIè¡¨ç¤º</button>
    <button id="btnHide">UIéè¡¨ç¤º</button>
    <button id="btnEnd">çµ‚äº†</button>
    <button id="btnRedWin">èµ¤å‹ã¡</button>
    <button id="btnBlueWin">é’å‹ã¡</button>
    <button id="btnXLSX">Excel</button>
  </div>

  <!-- è¿½åŠ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚²ãƒ¼ã‚¸ -->
  <div id="overlayGauge" class="fade1s">
    <div id="overlayRed"></div>
    <div id="overlayBlue"></div>
    <div id="overlayBorder"></div>
  </div>

  <!-- èµ¤ãƒãƒ¼ãƒ ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤º -->
  <div id="overlayRedTextBox" class="fade1s">
    <div class="pct-text" id="overlayRedPct">50%</div>
    <div class="count-text" id="overlayRedCount">(0ç¥¨)</div>
  </div>

  <!-- é’ãƒãƒ¼ãƒ ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤º -->
  <div id="overlayBlueTextBox" class="fade1s">
    <div class="pct-text" id="overlayBluePct">50%</div>
    <div class="count-text" id="overlayBlueCount">(0ç¥¨)</div>
  </div>

  <!-- æ®‹ã‚Šæ™‚é–“è¡¨ç¤º -->
  <div id="overlayTimerBox" class="fade1s">
    <div id="overlayTimerLabel">æ®‹ã‚Šæ™‚é–“</div>
    <div id="overlayTimerValue">4:00</div>
  </div>

  <!-- Exelã‚’å–ã‚Šæ‰±ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase + Firestore + ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <script type="module">
    import {
      getFirestore,
      doc,
      onSnapshot,
      setDoc,
      updateDoc,
      getDoc,
      getDocs,
      serverTimestamp,
      increment,
      collection,
      addDoc,
      query,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

    // ==== Firebase Config ====
    const firebaseConfig = {
      apiKey: "AIzaSyCVTEvN3EqebNOLlFdGfGA5612VkcRRbsQ",
      authDomain: "twitchchatdatabase.firebaseapp.com",
      projectId: "twitchchatdatabase",
      storageBucket: "twitchchatdatabase.firebasestorage.app",
      messagingSenderId: "861792479829",
      appId: "1:861792479829:web:9afe238a03f6527a55c2dc",
      measurementId: "G-3N10HW4NEY"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const pollsCol = collection(db, "polls");

    // ==== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ====
    function parseLaunchParams() {
      const search = window.location.search.toLowerCase();
      const params = new URLSearchParams(window.location.search);

      // ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆä¸¡æ–¹å«ã‚“ã§OKï¼‰
      const mode = {
        viewer: search.includes("viewer"),
        log: search.includes("log"),
      };

      // ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
      const urlParam = params.get("url");
      const channelList = [];
      if (urlParam) {
        for (const u of urlParam.split(",")) {
          const ch = extractChannelName(u.trim());
          if (ch) channelList.push(ch);
        }
      }

      return { mode, channelList };
    }
    function extractChannelName(raw) {
      if (!raw) return null;
      let str = raw.trim();

      // @ãƒ¦ãƒ¼ã‚¶ãƒ¼å â†’ URLåŒ–
      if (str.startsWith("@")) {
        str = "https://www.twitch.tv/" + str.slice(1);
      }

      // twitch.tvçœç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¾‹: twitch.tv/omapeko ã‚„ omapekoï¼‰
      if (!/^https?:\/\//i.test(str)) {
        if (/^twitch\.tv\//i.test(str)) {
          str = "https://" + str;
        } else if (!str.includes(".")) {
          // ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒãªã‘ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼åã ã‘ã¨ã¿ãªã™
          str = "https://www.twitch.tv/" + str;
        }
      }

      // å®Ÿéš›ã®ãƒãƒ£ãƒ³ãƒãƒ«åã‚’æŠ½å‡º
      const m = str.match(/twitch\.tv\/([^\/?#&]+)/i);
      return m ? m[1].toLowerCase() : null;
    }

    let currentPollRef = null;   // æœ€æ–°Pollã®DocRef
    let currentPollId  = null;   // æœ€æ–°Pollã®ID

    // === æœ€æ–°pollã‚’ç›£è¦–ã™ã‚‹ ===
    function watchLatestPoll(viewerMode){
      const q = query(collection(db,"polls"), orderBy("createdAt","desc"), limit(1));
      onSnapshot(q, (snap)=>{
        if (snap.empty) return;
        const docSnap = snap.docs[0];
        currentPollRef = docSnap.ref;
        currentPollId  = docSnap.id;

        const data = docSnap.data() || {};

        // ç¥¨æ›´æ–°
        const v = data.votes || {red:0, blue:0};
        updateBars(v.red, v.blue);

        // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
        if (data.endTime) {
          endTime = data.endTime;
        }

        // viewerãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã ã‘ visible åˆ¶å¾¡
        if (viewerMode) {
          // âœ… UIè¡¨ç¤ºåˆ¶å¾¡
          if (data.visible) {
            guardEl.style.display = "none";

          } else {
            guardEl.style.display = "block";
          }
        }
      });
    }

    // === defaultãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç›£è¦–ã—ã¦UIè¡¨ç¤ºåˆ¶å¾¡ ===
    function watchDefaultVisibility() {
      const { mode } = parseLaunchParams(); // â† vieweråˆ¤å®šã«ä½¿ã†
      const defaultRef = doc(db, "polls", "default");

      onSnapshot(defaultRef, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();
        const visible = !!data.visible;

        const bgEl    = document.getElementById("overlayBackground");
        const frameEl = document.getElementById("overlayGauge");
        const redBox  = document.getElementById("overlayRedTextBox");
        const blueBox = document.getElementById("overlayBlueTextBox");
        const timerBox = document.getElementById("overlayTimerBox");

        // âœ… viewerãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã ã‘ãƒ•ã‚§ãƒ¼ãƒ‰åˆ¶å¾¡ã‚’è¡Œã†
        if (mode.viewer) {
          if (visible) {
            console.log("true (viewer mode)");
            [frameEl, redBox, blueBox, timerBox, bgEl].forEach(el => el?.classList.add("show"));
          } else {
            console.log("false (viewer mode)");
            [frameEl, redBox, blueBox, timerBox, bgEl].forEach(el => el?.classList.remove("show"));
          }
        } else {
          // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ã¯å¸¸ã«è¡¨ç¤º
          [frameEl, redBox, blueBox, timerBox].forEach(el => el?.classList.add("show"));
        }
      });
    }

    // ==== æŠ•ç¥¨ãƒ­ã‚¸ãƒƒã‚¯ ====
    let ws = null, finished = false;
    const userVotes = Object.create(null);
    let endTime = null;

    const guardEl = document.getElementById("rootHiddenGuard");
    const breakdownEl = document.getElementById("breakdown");
    const redPctEl = document.getElementById("redPct");
    const bluePctEl= document.getElementById("bluePct");
    const redCntEl = document.getElementById("redCount");
    const blueCntEl= document.getElementById("blueCount");

    // ==== WebSocketæ¥ç¶šï¼ˆè¤‡æ•°JOIN + logå¯¾å¿œï¼‰ ====
    function connectMultipleChannels(channels, launchMode) {
      if (!channels.length) return;

      ws = new WebSocket("wss://irc-ws.chat.twitch.tv:443");

      ws.onopen = () => {
        ws.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");
        ws.send("PASS SCHMOOPIIE");
        ws.send("NICK justinfan" + Math.floor(Math.random() * 100000));

        for (const ch of channels) {
          ws.send("JOIN #" + ch);
          console.log(`âœ… JOINED: #${ch}`);
        }
      };

      ws.onmessage = (ev) => {
        const raw = ev.data.trim();
        if (raw.startsWith("PING")) { ws.send("PONG :tmi.twitch.tv"); return; }

        for (const line of raw.split("\n")) {
          if (!line.includes("PRIVMSG")) continue;

          const msg  = getMessageText(line);
          const tags = parseTags(line);
          const uid  = getStableUserId(tags, line);
          if (!uid) continue;
          const displayName = tags["display-name"] || uid;
          const channel = (line.match(/#([a-zA-Z0-9_]+)/) || [])[1] || "unknown";

          // ğŸ’¬ ãƒ­ã‚°å‡ºåŠ›ï¼šviewerãƒ¢ãƒ¼ãƒ‰ã§ã¯ç„¡åŠ¹åŒ–
          if (!launchMode.viewer) {
            console.log(`[é…ä¿¡: ${channel}] ğŸ’¬ ${displayName} (${uid}): ${msg}`);
          }

          // ğŸ’¬ Logãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã®ã¿è©³ç´°ãƒ­ã‚°å‡ºåŠ›
          if (launchMode.log) {
            console.log(`[LOGãƒ¢ãƒ¼ãƒ‰] ${channel} | ${displayName}: ${msg}`);
          }

          if (!launchMode.viewer && !launchMode.log) return;
          if (finished || !currentPollId) return;

          let vote = null;
          const normalizedMsg = msg.toLowerCase().replace(/[ï¼!]/g, "!");
          if (/! *(èµ¤|ã‚ã‹|aka|red)/i.test(normalizedMsg)) vote = "red";
          else if (/! *(é’|ã‚ãŠ|ao|blue)/i.test(normalizedMsg)) vote = "blue";
          if (!vote) continue;

          registerOrChangeVote(currentPollId, uid, displayName, vote);
        }
      };
    }

    function getMessageText(line){
      const i = line.indexOf(" PRIVMSG ");
      if (i < 0) return "";
      const part = line.slice(i);
      const c = part.indexOf(" :");
      return c >= 0 ? part.slice(c+2) : "";
    }
    function parseTags(line){
      const firstSpace = line.indexOf(" ");
      const tagsPart = firstSpace > 0 ? line.slice(0, firstSpace) : "";
      const obj = {};
      for (const kv of tagsPart.split(";")) {
        const [k, v] = kv.split("=");
        if (k) obj[k] = v || "";
      }
      return obj;
    }
    function getStableUserId(tags, line){
      if (tags["user-id"]) return tags["user-id"];
      if (tags["login"]) return tags["login"];
      const m = line.match(/^[^ ]+\s:([^!]+)!/);
      if (m) return m[1].toLowerCase();
      return null;
    }


    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¥¨å‡¦ç†
    async function registerOrChangeVote(pollId, uid, displayName, color) {
      const pollRef = doc(db, "polls", pollId);
      const pollSnap = await getDoc(pollRef);
      if (!pollSnap.exists()) return;
      const pollData = pollSnap.data();

      // çµ‚äº†æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
      if (pollData.finished || Date.now() > pollData.endTime) {
        console.log("â° æŠ•ç¥¨å—ä»˜çµ‚äº†æ¸ˆã¿ã§ã™");
        return;
      }

      // votersã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å‚ç…§
      const voterRef = doc(db, "polls", pollId, "voters", displayName);
      const voterSnap = await getDoc(voterRef);

      // ğŸ”¸ åˆå›æŠ•ç¥¨
      if (!voterSnap.exists()) {
        await setDoc(voterRef, {
          name: displayName,
          uid: uid,
          choice: color
        });
        await updateDoc(pollRef, {
          [`votes.${color}`]: increment(1)
        });
        console.log(`ğŸ—³ï¸ æ–°è¦æŠ•ç¥¨: ${displayName} â†’ ${color}`);
      } 
      // ğŸ”¸ æŠ•ç¥¨å¤‰æ›´ï¼ˆè‰²ãŒå¤‰ã‚ã£ãŸã¨ãã ã‘å·®ã—å¼•ãï¼‰
      else {
        const prevChoice = voterSnap.data().choice;
        if (prevChoice !== color) {
          await updateDoc(pollRef, {
            [`votes.${prevChoice}`]: increment(-1),
            [`votes.${color}`]: increment(1)
          });
          await updateDoc(voterRef, { choice: color });
          console.log(`ğŸ” æŠ•ç¥¨å¤‰æ›´: ${displayName} â†’ ${color}`);
        }
      }
    }

    //æŠ•ç¥¨ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã‚²ãƒ¼ã‚¸ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
    function updateBars(red, blue){
      const total = red + blue;
      let redPct = total > 0 ? Math.round((red/total)*1000)/10 : 50;

      // ã“ã“ã‹ã‚‰è¿½åŠ ï¼šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚²ãƒ¼ã‚¸ã‚‚åŒæœŸã•ã›ã‚‹
      const oRed   = document.getElementById("overlayRed");
      const oBlue  = document.getElementById("overlayBlue");
      const oLine  = document.getElementById("overlayBorder");
      const oGauge = document.getElementById("overlayGauge");

      if (oRed && oBlue && oLine && oGauge) {
        // å¹…ã‚’%ã§
        oRed.style.width  = redPct + "%";
        oBlue.style.width = (100 - redPct) + "%";

        // å¢ƒç•Œç·šã®ä½ç½®ã‚’pxã§è¨ˆç®—
        const gaugeWidth = oGauge.offsetWidth || 1382; // ä¿é™ºã§å›ºå®šå€¤
        const lineLeft = gaugeWidth * (redPct / 100);
        oLine.style.left = lineLeft + "px";
      }

      // è¿½åŠ ï¼šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®%ã¨ç¥¨æ•°ã‚‚æ›´æ–°
      const oRedPctEl = document.getElementById("overlayRedPct");
      const oRedCntEl = document.getElementById("overlayRedCount");
      const oBluePctEl = document.getElementById("overlayBluePct");
      const oBlueCntEl = document.getElementById("overlayBlueCount");

      if (oRedPctEl && oRedCntEl && oBluePctEl && oBlueCntEl) {
        // redPct ã¯ä¸Šã§è¨ˆç®—æ¸ˆã¿
        const bluePct = 100 - redPct;

        oRedPctEl.textContent = redPct.toFixed(0) + "%";
        oBluePctEl.textContent = bluePct.toFixed(0) + "%";

        oRedCntEl.textContent = `(${red}ç¥¨)`;
        oBlueCntEl.textContent = `(${blue}ç¥¨)`;
      }
    }

    // 1ç§’ã”ã¨ã«æ®‹ã‚Šæ™‚é–“ã‚’è¡¨ç¤º
    setInterval(()=>{
      if (endTime) {
        const remainingMs = endTime - Date.now();
        const remainingSec = Math.max(0, Math.floor(remainingMs/1000));
        renderTime(remainingSec);
      }
    }, 1000);

    function renderTime(sec){
      const m = String(Math.floor(sec/60));
      const s = String(sec%60).padStart(2,"0");
      const overlayTimerValue = document.getElementById("overlayTimerValue");
      const overlayTimerLabel = document.getElementById("overlayTimerLabel");

      if (sec > 0) {
        const timeText = `${m}:${s}`;
        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã»ã†
        if (overlayTimerValue) overlayTimerValue.textContent = timeText;
        // ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
        if (overlayTimerLabel) overlayTimerLabel.style.display = "block";
      } else {
        if (overlayTimerValue) overlayTimerValue.textContent = "å—ä»˜çµ‚äº†";
        // ãƒ©ãƒ™ãƒ«ã‚’éš ã™
        if (overlayTimerLabel) overlayTimerLabel.style.display = "none";
      }
    }

    // ==== ç®¡ç†è€…ãƒœã‚¿ãƒ³ ====
    const { mode } = parseLaunchParams();
    const isAdmin = !mode.viewer && !mode.log;
    document.getElementById("adminPanel").hidden = !isAdmin;

    // ==== æŠ•ç¥¨é–‹å§‹ï¼ˆæ–°ã—ã„pollã‚’ä½œã‚‹ï¼‰====
    document.getElementById("btnStart").addEventListener("click", async ()=>{
      // æ—¥æ™‚ã‹ã‚‰IDç”Ÿæˆ
      const now = new Date();
      const id = now.toISOString().replace(/[:.]/g,"-"); // 2025-10-02T14-33-15-123Z â†’ 2025-10-02T14-33-15-123Z
      const pollRef = doc(collection(db,"polls"), id);

      await setDoc(pollRef, {
        visible: true,
        votes: { red: 0, blue: 0 },
        endTime: Date.now() + 240000, // â† æŠ•ç¥¨æ™‚é–“4åˆ†
        createdAt: serverTimestamp()
      });

      currentPollRef = pollRef;
      currentPollId  = id;
    });

    // ==== ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ ====
    document.getElementById("btnRestart").addEventListener("click", async ()=>{
      if (!currentPollRef) return;
      await updateDoc(currentPollRef, { endTime: Date.now() + 240000  });
    });

    // ==== å…¨ãƒªã‚»ãƒƒãƒˆ ====
    document.getElementById("btnReset").addEventListener("click", async ()=>{
      if (!currentPollRef) return;
      await updateDoc(currentPollRef, {
        votes: { red: 0, blue: 0 },
        endTime: Date.now() + 240000
      });
    });

    function setupLongPress(btnId, color) {
      const btn = document.getElementById(btnId);
      let intervalId = null, timeoutId = null, isPressed = false;
      const startPress = async () => {
        isPressed = true;
        if (currentPollRef) await updateDoc(currentPollRef, { [`votes.${color}`]: increment(1) });
        timeoutId = setTimeout(() => {
          if (isPressed) {
            intervalId = setInterval(async ()=>{
              if (!isPressed || !currentPollRef) return;
              await updateDoc(currentPollRef, { [`votes.${color}`]: increment(1) });
            },200);
          }
        },1000);
      };
      const endPress = ()=>{
        isPressed = false;
        clearTimeout(timeoutId);
        clearInterval(intervalId);
      };
      btn.addEventListener("mousedown", startPress);
      btn.addEventListener("mouseup", endPress);
      btn.addEventListener("mouseleave", endPress);
    }
    setupLongPress("btnRed","red");
    setupLongPress("btnBlue","blue");

    document.getElementById("btnShow").addEventListener("click", async ()=>{
      const defaultRef = doc(db, "polls", "default");
      await setDoc(defaultRef, { visible: true }, { merge: true });
    });

    // UIéè¡¨ç¤º
    document.getElementById("btnHide").addEventListener("click", async ()=>{
      const defaultRef = doc(db, "polls", "default");
      await setDoc(defaultRef, { visible: false }, { merge: true });
    });

    // ==== èµ·å‹•æ™‚å‡¦ç† ====
    window.addEventListener("load", () => {
      const { mode, channelList } = parseLaunchParams();

      if (channelList.length) connectMultipleChannels(channelList, mode);

      // viewer or logã©ã¡ã‚‰ã‹ã‚’å«ã‚“ã§ã„ã‚Œã°UIèµ·å‹•
      if (mode.viewer || mode.log) {
        watchLatestPoll(true);
      } else {
        // adminãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        watchLatestPoll(false);
        guardEl.style.display = "none";
      }

      watchDefaultVisibility();

    });

    // ==== çµ‚äº†ãƒœã‚¿ãƒ³ ====
    document.getElementById("btnEnd").addEventListener("click", async ()=>{
      if (!currentPollRef) return;

      const now = Date.now();

      // Firestoreæ›´æ–°
      await updateDoc(currentPollRef, {
        finished: true,
        endTime: now
      });

      // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚‚çµ‚äº†æ‰±ã„ã«
      finished = true;
      endTime = now;
    });

  // çµæœè¡¨ç¤ºé–¢æ•°ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã—ã¦10ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼‰
  function showResult(html) {
    winnerEl.innerHTML = html;
    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
    resultEl.classList.add("show");

    // 10ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    setTimeout(() => {
      resultEl.classList.remove("show");
    }, 10000);
  }

  // ==== èµ¤å‹ã¡ ====
  document.getElementById("btnRedWin").addEventListener("click", async () => {
    if (!currentPollRef) return;
    await updateDoc(currentPollRef, {
      winner: "red"
    });
    console.log("âœ… winner:red ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  });

  // ==== é’å‹ã¡ ====
  document.getElementById("btnBlueWin").addEventListener("click", async () => {
    if (!currentPollRef) return;
    await updateDoc(currentPollRef, {
      winner: "blue"
    });
    console.log("âœ… winner:blue ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  });


  //----------------------------------------------------
  // Excelã«å‡ºåŠ›ï¼ˆæœ€çµ‚çµæœã‚·ãƒ¼ãƒˆä»˜ãï¼‰
  //----------------------------------------------------

  // Excelã§ä½¿ãˆãªã„æ–‡å­—ã‚’ã‚·ãƒ¼ãƒˆåã‹ã‚‰é™¤å»ã™ã‚‹ã‚„ã¤
  function sanitizeSheetName(name) {
    // Excelã§ç¦æ­¢ã•ã‚Œã¦ã‚‹æ–‡å­—: : \ / ? * [ ]
    return name.replace(/[:\\\/\?\*\[\]]/g, "").slice(0, 31);
  }

  async function exportRecentPollsToXLSX() {
    try {
      const thisYear = String(new Date().getFullYear());

      // pollsã‚’æ–°ã—ã„é †ã§å¤šã‚ã«å–ã‚‹
      const pollsQuery = query(
        collection(db, "polls"),
        orderBy("createdAt", "desc"),
        limit(30)
      );
      const pollSnaps = await getDocs(pollsQuery);

      // å¹´ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã ã‘ã«çµã‚‹
      const targetPolls = [];
      pollSnaps.forEach((docSnap) => {
        const id = docSnap.id || "";
        if (id.startsWith(thisYear + "-")) {
          // ãƒ‡ãƒ¼ã‚¿ã‚‚ã“ã“ã§æŒã£ã¦ãŠãï¼ˆwinnerã‚’ä½¿ã†ã®ã§ï¼‰
          targetPolls.push({ id, ref: docSnap.ref, data: docSnap.data() || {} });
        }
      });

      // æœ€æ–°5ä»¶
      const selectedPolls = targetPolls.slice(0, 5);

      // ã“ã“ã§ã€Œuidã”ã¨ã®ãƒã‚¤ãƒ³ãƒˆã€ã‚’é›†è¨ˆã—ã¦ã„ã
      // scores[uid] = { name, uid, point }
      const scores = Object.create(null);

      // ã‚ã¨ã§ãƒ–ãƒƒã‚¯ã«è¿½åŠ ã™ã‚‹ãŸã‚ã«ã€å„pollã”ã¨ã®ã‚·ãƒ¼ãƒˆã‚‚ä¿å­˜ã—ã¦ãŠã
      const pollSheets = [];

      for (const poll of selectedPolls) {
        const votersSnap = await getDocs(collection(poll.ref, "voters"));

        // 1è¡Œç›®ãƒ˜ãƒƒãƒ€ãƒ¼
        const rows = [
          ["name", "uid", "choice"]
        ];

        const winnerColor = poll.data.winner || ""; // "red" / "blue" / "" ã‹ã‚‚
        // è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ï¼†ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹
        votersSnap.forEach((voterDoc) => {
          const d = voterDoc.data() || {};
          const name = d.name || voterDoc.id || "";
          const uid = d.uid || "";
          const choice = d.choice || "";

          rows.push([name, uid, choice]);

          // ã‚¹ã‚³ã‚¢åŠ ç®—ï¼ˆwinnerãŒå…¥ã£ã¦ã¦ã€choiceãŒä¸€è‡´ã—ã¦ã„ã‚‹äººã ã‘1ptï¼‰
          if (winnerColor && choice === winnerColor && uid) {
            if (!scores[uid]) {
              scores[uid] = { name, uid, point: 0 };
            }
            scores[uid].point += 1;
          }
        });

        // rows â†’ worksheet ã«å¤‰æ›
        const ws = XLSX.utils.aoa_to_sheet(rows);

        // E1 ã« winner ã®è‰²ã‚’æ›¸ãè¾¼ã‚€ï¼ˆä¾‹: "red"ï¼‰
        if (winnerColor) {
          ws["E1"] = { t: "s", v: winnerColor };
        } else {
          ws["E1"] = { t: "s", v: "" };
        }
        
        // ã‚·ãƒ¼ãƒˆã®ç¯„å›²ã‚’E1ã¾ã§åºƒã’ã‚‹
        if (!ws['!ref']) {
          ws['!ref'] = "A1:E1";
        } else {
          const range = XLSX.utils.decode_range(ws['!ref']);
          // 4 ã¯ 0å§‹ã¾ã‚Šã§Eåˆ—
          if (range.e.c < 4) {
            range.e.c = 4;
            ws['!ref'] = XLSX.utils.encode_range(range);
          }
        }

        const sheetName = sanitizeSheetName(poll.id);
        pollSheets.push({ sheetName, ws });
      }

      // ã“ã“ã¾ã§ã§ scores ã«å…¨å“¡åˆ†ã® point ãŒå…¥ã£ãŸã®ã§ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œã‚‹
      const scoreArray = Object.values(scores);
      // pointé™é † â†’ åå‰é †ãã‚‰ã„ã§ã‚½ãƒ¼ãƒˆ
      scoreArray.sort((a, b) => {
        if (b.point !== a.point) return b.point - a.point;
        return (a.name || "").localeCompare(b.name || "");
      });

      // ã€Œæœ€çµ‚çµæœã€ã‚·ãƒ¼ãƒˆã‚’ä½œã‚‹
      const finalRows = [
        ["name", "uid", "point"]
      ];
      scoreArray.forEach((item) => {
        finalRows.push([item.name, item.uid, item.point]);
      });
      const finalWs = XLSX.utils.aoa_to_sheet(finalRows);

      // ãƒ–ãƒƒã‚¯ã‚’ä½œã£ã¦ã€ã¾ãšã€Œæœ€çµ‚çµæœã€ã‚’ä¸€ç•ªæœ€åˆã«å…¥ã‚Œã‚‹
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, finalWs, "æœ€çµ‚çµæœ");

      // ãã®ã‚ã¨ã«å„pollã‚·ãƒ¼ãƒˆã‚’è¿½åŠ 
      for (const ps of pollSheets) {
        XLSX.utils.book_append_sheet(wb, ps.ws, ps.sheetName);
      }

      // ä¿å­˜
      const nowStr = new Date().toISOString().slice(0, 10); // 2025-11-06
      const fileName = `${nowStr}_polls_voters.xlsx`;
      XLSX.writeFile(wb, fileName);

      console.log("âœ… Excelå‡ºåŠ›å®Œäº†ï¼ˆæœ€çµ‚çµæœã¤ãï¼‰");
    } catch (err) {
      console.error("Excelå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼: ", err);
    }
  }

  // ãƒœã‚¿ãƒ³ã«ç´ä»˜ã‘ï¼ˆã“ã‚Œã¯ãã®ã¾ã¾ï¼‰
  document.getElementById("btnXLSX")?.addEventListener("click", exportRecentPollsToXLSX);




  </script>

</body>
</html>
